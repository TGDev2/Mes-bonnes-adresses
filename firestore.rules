// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }
    function isOwner(ownerId) {
      return signedIn() && request.auth.uid == ownerId;
    }
    function addr(path) {
      return get(/databases/$(database)/documents/addresses/$(path));
    }

    // ── Addresses ──────────────────────────────────────────────────────────────
    match /addresses/{addressId} {
      // Lecture autorisée si l'adresse est publique OU si l'utilisateur est propriétaire
      allow get, list, read: if resource.data.isPublic == true || isOwner(resource.data.userId);

      // Création par un utilisateur connecté pour son propre userId
      allow create: if signedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.isPublic is bool
        && request.resource.data.location is latlng;

      // Mise à jour par le propriétaire uniquement. L'owner ne peut pas changer.
      allow update: if isOwner(resource.data.userId)
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.isPublic is bool
        && request.resource.data.location is latlng;

      // Suppression par le propriétaire uniquement
      allow delete: if isOwner(resource.data.userId);
    }

    // ── Comments (sous-collection) ────────────────────────────────────────────
    match /addresses/{addressId}/comments/{commentId} {
      // Lecture si l'adresse est publique ou si l'utilisateur est propriétaire de l'adresse
      allow get, list, read: if addr(addressId).data.isPublic == true
                             || isOwner(addr(addressId).data.userId);

      // Création : utilisateur connecté, auteur == auth.uid
      // et l'adresse est publique OU l'utilisateur est propriétaire de l'adresse
      allow create: if signedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.text is string
        && request.resource.data.text.size() > 0
        && (addr(addressId).data.isPublic == true || request.auth.uid == addr(addressId).data.userId);

      // Suppression : uniquement l'auteur du commentaire
      allow delete: if signedIn() && resource.data.userId == request.auth.uid;

      // (Pas d'update de commentaires prévu ; sinon à restreindre à l'auteur)
    }
  }
}
